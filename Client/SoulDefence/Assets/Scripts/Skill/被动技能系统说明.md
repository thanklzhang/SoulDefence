# 被动技能系统说明

## 概述

被动技能系统为技能添加了被动效果支持。一个技能可以：
- 纯主动技能（原有功能）
- 纯被动技能（不需要释放）
- 主动+被动技能（主动效果和被动效果共存）

## 文件结构

```
Skill/
├── PassiveSkillEnums.cs        # 被动技能枚举定义
├── PassiveSkillData.cs         # 被动技能配置数据
├── PassiveSkillInstance.cs     # 被动技能实例（运行时）
├── PassiveSkillSystem.cs       # 被动技能系统管理
└── SkillData.cs                # 扩展支持被动技能
```

## 核心枚举

### PassiveTriggerType（触发类型）

| 类型 | 说明 | 用途示例 |
|------|------|---------|
| None | 无触发（永久生效） | 属性加成 |
| OnAttack | 攻击时触发 | 每次攻击额外伤害 |
| OnHit | 受击时触发 | 受击时反伤 |
| OnKill | 击杀时触发 | 击杀回血 |
| Interval | 定时触发 | 每5秒回血 |
| OnHealthLow | 生命值低时触发 | 生命值低于30%时获得护盾 |
| OnAttackCount | 攻击次数触发 | 每3次攻击触发 |

### PassiveEffectType（效果类型）

| 类型 | 说明 | 配置参数 |
|------|------|---------|
| AttributeBonus | 属性加成 | attributeBonusValue, attributeType |
| DamageMultiplier | 伤害倍率 | damageMultiplier |
| ExtraDamage | 额外伤害 | extraDamage |
| CriticalHit | 暴击 | criticalMultiplier |
| DamageReduction | 伤害减免 | damageReductionPercent |
| Shield | 护盾 | shieldAmount |
| HealthRegen | 生命恢复 | healAmount |

## 配置方式

### 在 SkillData 中配置被动技能

1. 打开或创建技能配置（SkillData）
2. 找到 "被动技能配置" 部分
3. 勾选 `Enabled` 启用被动技能
4. 配置被动技能参数

### 配置示例

#### 示例1：每3次攻击触发额外伤害

```
被动技能配置：
  enabled: true
  passiveName: "连击强化"
  description: "每攻击3次，第4次攻击造成150%伤害"
  
  触发条件：
    triggerType: OnAttackCount
    attackCountThreshold: 3
  
  效果配置：
    effectType: DamageMultiplier
    damageMultiplier: 1.5
  
  冷却配置：
    hasCooldown: false
```

#### 示例2：永久增加攻击力

```
被动技能配置：
  enabled: true
  passiveName: "力量强化"
  description: "永久增加攻击力"
  
  触发条件：
    triggerType: None  (永久生效)
  
  效果配置：
    effectType: AttributeBonus
    attributeType: 0  (0=攻击力)
    attributeBonusValue: 10
```

#### 示例3：定时恢复生命

```
被动技能配置：
  enabled: true
  passiveName: "生命回复"
  description: "每5秒恢复20点生命"
  
  触发条件：
    triggerType: Interval
    intervalTime: 5
  
  效果配置：
    effectType: HealthRegen
    healAmount: 20
```

#### 示例4：受击时伤害减免

```
被动技能配置：
  enabled: true
  passiveName: "坚韧"
  description: "受到攻击时减免20%伤害"
  
  触发条件：
    triggerType: OnHit
  
  效果配置：
    effectType: DamageReduction
    damageReductionPercent: 0.2  (20%)
  
  冷却配置：
    hasCooldown: true
    cooldownTime: 10
```

## 主动+被动组合技能

一个技能可以同时拥有主动和被动效果：

```
基础信息：
  skillName: "烈焰斩"
  
主动技能参数：
  hasActiveSkill: true  ✅
  damage: 50
  skillType: Melee
  cooldown: 5
  
被动技能配置：
  enabled: true  ✅
  passiveName: "燃烧之力"
  description: "每次攻击附加10点火焰伤害"
  
  triggerType: OnAttack
  effectType: ExtraDamage
  extraDamage: 10
```

这样配置后：
- 主动释放造成50点近战伤害（主动效果）
- 每次攻击附加10点火焰伤害（被动效果）

## 纯被动技能

如果只需要被动效果，不需要主动释放：

```
主动技能参数：
  hasActiveSkill: false  ❌ 关闭主动技能
  
被动技能配置：
  enabled: true  ✅ 启用被动技能
  ...其他被动配置
```

## 使用方式

### 被动技能自动运行

被动技能会自动：
- 初始化时加载
- 每帧更新（定时触发、生命值监测等）
- 在对应事件时触发（攻击、受击、击杀等）

### 触发事件

```csharp
// 攻击时触发（在使用技能时自动调用）
entity.SkillSystem.OnAttack();

// 受击时触发
entity.SkillSystem.OnHit();

// 击杀时触发
entity.SkillSystem.OnKill();
```

### 获取被动技能效果

```csharp
// 获取攻击伤害修正
float extraDamage = entity.SkillSystem.GetPassiveDamageModifier(baseDamage);
float finalDamage = baseDamage + extraDamage;

// 获取受击伤害减免
float reduction = entity.SkillSystem.GetPassiveDamageReduction(incomingDamage);
float actualDamage = incomingDamage - reduction;
```

### 访问被动技能系统

```csharp
// 获取被动技能系统
var passiveSystem = entity.SkillSystem.PassiveSkillSystem;

// 获取被动技能数量
int count = passiveSystem.GetPassiveSkillCount();

// 添加被动技能
passiveSystem.AddPassiveSkill(newSkill);

// 移除被动技能
passiveSystem.RemovePassiveSkill(index);

// 重置所有被动技能
passiveSystem.ResetAll();
```

## 属性类型说明

attributeType 参数对应的属性：
- 0 = 攻击力 (AttackPower)
- 1 = 防御力 (Defense)
- 2 = 攻击速度 (AttackSpeed)
- 3 = 移动速度 (MoveSpeed)

## 集成说明

### 自动集成

被动技能系统已自动集成到：
- ✅ EntitySkillSystem
- ✅ GameEntity
- ✅ 技能使用流程

### 触发时机

| 事件 | 触发位置 | 说明 |
|------|---------|------|
| 攻击 | UseSkill() | 使用技能时自动触发 |
| 受击 | TakeDamage() | 需要在受伤逻辑中调用 |
| 击杀 | OnDeath() | 需要在目标死亡时调用 |
| 定时 | Update() | 自动更新 |
| 生命值低 | Update() | 自动检测 |

## 设计特点

### ✅ 高度可配置
- 多种触发类型
- 多种效果类型
- 参数化配置

### ✅ 灵活组合
- 主动+被动
- 纯被动
- 多个被动技能叠加

### ✅ 易于扩展
- 添加新触发类型：修改 PassiveTriggerType 枚举
- 添加新效果类型：修改 PassiveEffectType 枚举并实现效果逻辑
- 自定义效果：使用 Custom 类型

### ✅ 运行时管理
- 动态添加/移除被动技能
- 重置被动技能状态
- 冷却管理

## 复杂技能配置示例

### 战士终极技能

```
技能名称：狂战士之怒

主动效果：
  hasActiveSkill: true
  skillType: Melee
  damage: 100
  arcAngle: 120
  targetCount: 5
  cooldown: 30
  
被动效果（1）：
  passiveName: "战斗狂热"
  description: "击杀敌人时恢复20%最大生命值"
  
  triggerType: OnKill
  effectType: HealthRegen
  healAmount: (由外部根据最大生命值计算)
  
被动效果（2）：
  passiveName: "不屈意志"
  description: "生命值低于30%时减免50%伤害"
  
  triggerType: OnHealthLow
  healthThreshold: 30
  effectType: DamageReduction
  damageReductionPercent: 0.5
  hasCooldown: true
  cooldownTime: 60
```

**注意**：目前一个技能只支持一个被动效果，如需多个被动，可以配置多个技能。

## 待完善功能

### 当前限制
- 一个技能只能有一个被动效果
- 护盾系统需要单独实现
- 部分效果（如眩晕、减速）需要Buff系统支持

### 未来扩展
- 支持一个技能多个被动效果
- 条件触发（如暴击后触发）
- 概率触发（如20%概率触发）
- Buff系统集成
- 被动技能升级系统

## 测试建议

1. **属性加成测试**：配置永久攻击力加成，检查属性是否正确增加
2. **攻击触发测试**：配置攻击时额外伤害，观察伤害变化
3. **攻击次数测试**：配置每3次攻击，测试是否正确计数
4. **定时触发测试**：配置定时回血，观察是否按时触发
5. **生命值触发测试**：配置生命值低触发，测试阈值是否正确
6. **冷却测试**：配置被动冷却，测试冷却是否生效

## 注意事项

1. **属性加成**：永久属性加成建议通过属性系统的组合模式实现（目前只是记录）
2. **护盾系统**：需要单独实现护盾管理
3. **触发时机**：确保在合适的位置调用触发事件
4. **性能考虑**：避免在被动技能中进行复杂计算
5. **配置检查**：确保触发类型和效果类型匹配

